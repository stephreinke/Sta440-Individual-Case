---
title: "Post Surgery Resting Engery Expenditure - STA440 Final Project"
author: "Steph Reinke"
date: "December 2025"
format: 
  pdf:
    documentclass: article
    geometry: margin=1in
execute: 
  warning: false
  message: false
  echo: false
editor: 
  markdown: 
    wrap: 72
---

# 1. Background
The recovery processes for surgery patients are often complex. Through understanding their metabolic needs, care can be optimized with targeted feeding. Indirect calorimetry (IC) is a standard method for measuring energy expenditure via respiration. Resting energy expenditure (REE), measured via IC, plays a key role in guiding nutritional support, which can improve post surgery patient outcomes. The goal of this study was to measure REE and REE/kg in these patients during their stays in the intensive care unit (ICU) and subsequently in the step–down unit (SDU), so that this information can be used to improve post–surgery care. A total of 11 patients (4 obese, 7 non–obese) were included in the study, with 35 indirect REE measurements taken throughout their recoveries to capture different stages of metabolic demand. These measurements were collected repeatedly, allowing for comparison between patients on ventilators versus those who were not, as well as between ICU and step–down unit patients.

## Research Question:
Characterize the relationship between resting energy expenditure and obesity status, ventilator status and patient location (ICU vs SDU). Are your conclusions the same when REE is weight adjusted (REEperKG)?

# 2. Data
REE was measured using indirect calorimetry within 72 hours of surgery and then every five to seven days throughout hospitalization. REE and REEperKG are the outcomes variables, REEperKG is REE adjusted for weight. Obese and ventilator are indicator variables for their respective factors. BMI is the patient's body mass index. Measurement is the measurement number for that observation. ICUorSDU tells if the patient was in the intesive care unit or the stepdown unit.

```{r}
#| label: read_data

library(tidyverse)
load("REE.RData")

```

# 3. EDA
In order to gain an understanding of the data exploratory data analysis was conducted. 

```{r}
plot1 <- REE |>
  ggplot(aes(x = REE, y = BMI, color = ICUorSDU)) +
  geom_point(alpha = .7,
             size = 2) +
  theme_minimal() +
  labs(title = "REE vs BMI by Hosptial Unit",
       color = "Hospital Unit")

plot2 <- REE |>
  ggplot(aes(y = REEperKG, fill = as.factor(Obese))) +
  geom_boxplot() +
  facet_grid(~Obese) +
  theme_minimal() +
  labs(title = "Distrbution of REE per KG by Obesity Status",
       y = "REE per KG",
       fill = "Obese") +
  theme(axis.text.x = element_blank())

plot3 <- REE |>
  ggplot(aes(y = REE, fill = as.factor(Measurement))) +
  geom_boxplot() +
  facet_grid(~as.factor(Measurement)) +
  theme_minimal() +
  labs(fill = "Measurement",
       title = "Distribution of REE by Measurement Number") +
  theme(axis.text.x = element_blank())

 plot2.5 <- REE |>
  ggplot(aes(y = REE, fill = as.factor(Obese))) +
  geom_boxplot() +
  facet_grid(~as.factor(Obese)) +
  theme_minimal() +
  labs(fill = "Measurement",
       title = "Distribution of REE by Measurement Number") +
  theme(axis.text.x = element_blank())
 
plot4 <- REE |>
  ggplot(aes(y = REE, fill = as.factor(Ventilator))) +
  geom_boxplot() +
  facet_grid(~Ventilator) +
  theme_minimal() +
  labs(title = "Distribution of REE by Ventilator Status",
       fill = "Ventilator") +
  theme(axis.text.x = element_blank())

plot5 <- REE |>
  ggplot(aes(x = Measurement, y = REE, group = ID, color = factor(ID))) +
  geom_line(alpha = .6) +
  geom_point() +
  theme_minimal() +
  labs(title = "Individual Patient REE Trajectories",
       x = "Measurement Number", color = "Patient ID")
plot1.5 <- REE |>
  ggplot(aes(x = REE, y = REEperKG, color = factor(Obese))) +
  geom_point(size = 2, alpha = 0.8) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal() +
  labs(title = "Relationship Between REE and REE per KG",
       x = "REE", y = "REE per KG", color = "Obese")
```

# 4. Modeling
We will take a frequentist apporach

```{r}
library(lme4)

fit_REE <- lmer(
  REE ~ Obese + Ventilator + ICUorSDU + (1 | ID),
  data = REE
)
summary(fit_REE)

fit_REEkg <- lmer(
  REEperKG ~ Obese + Ventilator + ICUorSDU + (1 | ID),
  data = REE
)
summary(fit_REEkg)
```

```{r}
library(pbkrtest)
print("Test for Obese")
fit_no_obese <- lmer(
  REE ~ Ventilator + ICUorSDU + (1 | ID),
  data = REE
)
KRmodcomp(fit_REE, fit_no_obese)

print("Test for Ventilator")
fit_no_vent <- lmer(
  REE ~ Obese + ICUorSDU + (1 | ID),
  data = REE
)
KRmodcomp(fit_REE, fit_no_vent)

print("Test for ICUorSDU")
fit_no_icu <- lmer(
  REE ~ Ventilator + Obese + (1 | ID),
  data = REE
)
KRmodcomp(fit_REE, fit_no_icu)
```

```{r}
library(pbkrtest)
print("Test for Obese")
fit_no_obesekg <- lmer(
  REEperKG ~ Ventilator + ICUorSDU + (1 | ID),
  data = REE
)
KRmodcomp(fit_REEkg, fit_no_obesekg)

print("Test for Ventilator")
fit_no_ventkg <- lmer(
  REEperKG ~ Obese + ICUorSDU + (1 | ID),
  data = REE
)
KRmodcomp(fit_REEkg, fit_no_ventkg)

print("Test for ICUorSDU")
fit_no_icukg <- lmer(
  REEperKG ~ Ventilator + Obese + (1 | ID),
  data = REE
)
KRmodcomp(fit_REEkg, fit_no_icukg)
```

```{r}
plot(fitted(fit_REE), resid(fit_REE))
abline(h = 0, col = "red", lwd = 2, lty = 2)
qqnorm(resid(fit_REE)); qqline(resid(fit_REE))
ranef(fit_REE)
qqnorm(ranef(fit_REE)$ID[,1])
```

```{r}
plot(fitted(fit_REEkg), resid(fit_REEkg))
abline(h = 0, col = "red", lwd = 2, lty = 2)
qqnorm(resid(fit_REEkg)); qqline(resid(fit_REEkg))
ranef(fit_REEkg)
qqnorm(ranef(fit_REEkg)$ID[,1])
```

# 6. Appendix
```{r}
#| fig-cap: Roughly linear between BMI and REE, more ICU at lower REEs
plot1
```
```{r}
#| fig-cap: REE per KG is lower for higher REEs and obese patients
plot1.5
```
```{r}
#| fig-cap: Non obese patients have larger range of REE per KG with higher median than obese patients
plot2
```
```{r}
#| fig-cap: Non obese patients have smaller median REE with lower IQR than obese patients
plot2.5
```

```{r}
#| fig-cap: Median REE is consistent, but range varies drastically over time
plot3
```

```{r}
#| fig-cap: Higher REE for patients not on ventilator, but similar ranges
plot4
```
```{r}
#| fig-cap: No clear trends by patient overtime
plot5
```
